# Ollama Reranker - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ‚úÖ

## –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

–ü–µ—Ä–µ–ø–∏—Å–∞–Ω `OllamaReranker` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å Ollama API.

### –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:

1. **–£–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π `/api/generate` –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `format`
2. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω –ø–∞—Ä—Å–∏–Ω–≥ –æ—Ç–≤–µ—Ç–∞** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `bodyAsText()` –≤–º–µ—Å—Ç–æ `body<T>()` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å `application/x-ndjson`
3. **–ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã** - 60 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞, 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
4. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç** - —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
5. **–£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ JSON** - –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ JSON –º–∞—Å—Å–∏–≤–∞ –∏–∑ –æ—Ç–≤–µ—Ç–∞ –º–æ–¥–µ–ª–∏
6. **–õ—É—á—à–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ fallback –Ω–∞ cosine scores

### –§–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞:

```json
{
  "model": "qwen2.5",
  "prompt": "...",
  "stream": false
}
```

### –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:

```json
{
  "model": "qwen2.5",
  "created_at": "2025-12-24T16:50:33Z",
  "response": "[{\"id\": 1, \"score\": 0.85}, ...]",
  "done": true
}
```

## –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### 1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Ollama –∑–∞–ø—É—â–µ–Ω

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ Ollama —Ä–∞–±–æ—Ç–∞–µ—Ç
curl http://localhost:11434/api/version

# –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∑–∞–ø—É—Å—Ç–∏—Ç–µ
ollama serve
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –º–æ–¥–µ–ª—å (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞)

```bash
# –ë–∞–∑–æ–≤–∞—è –º–æ–¥–µ–ª—å
ollama pull qwen2.5

# –ò–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è
ollama pull qwen2.5:3b
ollama pull qwen2.5:7b
```

### 3. –í–∫–ª—é—á–∏—Ç–µ re-ranking —á–µ—Ä–µ–∑ Ollama

```bash
export AILEARN_RAG_RERANKING=true
export AILEARN_RAG_RERANKING_PROVIDER=ollama
export AILEARN_RAG_RERANK_MODEL=qwen2.5

./gradlew run
```

### 4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ RAG —Å re-ranking

–í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–∑ –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:

```
üí¨ –í—ã: —á—Ç–æ —Ç–∞–∫–æ–µ ailearn?
```

### 5. –û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥

–í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:

```
üîç –ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π...

üìö –ù–∞–π–¥–µ–Ω–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤: 3
  1. [README.md] Cosine: 0.87 ‚Üí LLM: 0.94
  2. [ARCHITECTURE.md] Cosine: 0.82 ‚Üí LLM: 0.89
  3. [README.md.1] Cosine: 0.78 ‚Üí LLM: 0.85

ü§ñ –û—Ç–≤–µ—Ç:
[–û—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ re-ranked –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞]
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

–û—Ç–∫—Ä–æ–π—Ç–µ `ailearn.log` –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

```bash
tail -f ailearn.log | grep -i rerank
```

–£—Å–ø–µ—à–Ω—ã–π re-ranking:
```
INFO  LlmReranker - Re-ranking 20 candidates with Ollama model: qwen2.5
DEBUG LlmReranker - Ollama response done: true
DEBUG LlmReranker - Extracted JSON array: [{"id": 1, "score": 0.94}, ...]
INFO  LlmReranker - Successfully parsed 20 re-ranking scores from Ollama
```

## –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

### Ollama (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π)
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ
- ‚úÖ –ë–µ—Å–ø–ª–∞—Ç–Ω–æ
- ‚úÖ –•–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã–π Ollama
- ‚ö†Ô∏è –ú–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–º (30-60 —Å–µ–∫—É–Ω–¥ –¥–ª—è 20 –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤)
- üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 10-15 –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏/–∫–∞—á–µ—Å—Ç–≤–∞

### LlmProvider
- ‚úÖ –û—Ç–ª–∏—á–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å (~3-10 —Å–µ–∫—É–Ω–¥)
- ‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç API (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø–ª–∞—Ç–Ω—ã–º)

## Troubleshooting

### ‚ö†Ô∏è "Request timeout has expired" (FIXED ‚úÖ)
**–ü—Ä–æ–±–ª–µ–º–∞**: Ollama –Ω–µ —É—Å–ø–µ–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å re-ranking –∑–∞ 15 —Å–µ–∫—É–Ω–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.

**–†–µ—à–µ–Ω–∏–µ**: –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å —Ç–∞–π–º–∞—É—Ç–∞–º–∏:
- –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞: 60 —Å–µ–∫—É–Ω–¥
- –¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: 10 —Å–µ–∫—É–Ω–¥
- –¢–∞–π–º–∞—É—Ç —Å–æ–∫–µ—Ç–∞: 60 —Å–µ–∫—É–Ω–¥

### ‚ö†Ô∏è "NoTransformationFoundException" –∏–ª–∏ "ContentType: application/x-ndjson" (FIXED ‚úÖ)
**–ü—Ä–æ–±–ª–µ–º–∞**: 
```
Expected response body of the type 'OllamaGenerateResponse' but was 'SourceByteReadChannel'
Response header `ContentType: application/x-ndjson`
```

**–ü—Ä–∏—á–∏–Ω–∞**: Ollama –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `application/x-ndjson` (newline-delimited JSON) –¥–∞–∂–µ –∫–æ–≥–¥–∞ `stream=false`.

**–†–µ—à–µ–Ω–∏–µ**: –ò–∑–º–µ–Ω–µ–Ω —Å–ø–æ—Å–æ–± —á—Ç–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞:
```kotlin
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è bodyAsText() –≤–º–µ—Å—Ç–æ body<T>()
val rawResponse = httpResponse.bodyAsText()
val response = json.decodeFromString<OllamaGenerateResponse>(rawResponse)
```

### –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å**:
1. ‚úÖ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥
2. ‚úÖ Re-ranking —Ç–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å 30-60 —Å–µ–∫—É–Ω–¥ –¥–ª—è 20 –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
3. ‚úÖ –°–ª–µ–¥–∏—Ç–µ –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ–º: "‚è≥ Waiting for Ollama to re-rank candidates..."

**–î–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è**:
```bash
# –£–º–µ–Ω—å—à–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
export AILEARN_RAG_CANDIDATE_COUNT=10

# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—å—à—É—é –º–æ–¥–µ–ª—å
export AILEARN_RAG_RERANK_MODEL=qwen2.5:3b
```

### "Connection refused"
```bash
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Ollama –∑–∞–ø—É—â–µ–Ω
ollama serve
```

### "Model not found"
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –º–æ–¥–µ–ª—å
ollama pull qwen2.5
```

### "No JSON array found in response"
- –ú–æ–¥–µ–ª—å –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–æ–π –∏–ª–∏ –Ω–µ –ø–æ–¥—Ö–æ–¥—è—â–µ–π
- –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å: `qwen2.5:7b`, `llama3.2`, `mistral`

### Re-ranking –Ω–µ —É–ª—É—á—à–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- –£–≤–µ–ª–∏—á—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤: `export AILEARN_RAG_CANDIDATE_COUNT=30`
- –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å: `export AILEARN_RAG_RERANK_MODEL=qwen2.5:7b`

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ë—ã—Å—Ç—Ä–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (10-20 —Å–µ–∫—É–Ω–¥)
```bash
export AILEARN_RAG_CANDIDATE_COUNT=10
export AILEARN_RAG_RERANK_MODEL=qwen2.5:3b
```

### –ë–∞–ª–∞–Ω—Å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (20-40 —Å–µ–∫—É–Ω–¥) ‚≠ê –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è
```bash
export AILEARN_RAG_CANDIDATE_COUNT=15
export AILEARN_RAG_RERANK_MODEL=qwen2.5
```

### –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (40-60 —Å–µ–∫—É–Ω–¥)
```bash
export AILEARN_RAG_CANDIDATE_COUNT=20
export AILEARN_RAG_RERANK_MODEL=qwen2.5:7b
```

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–æ–¥–µ–ª–∏

| –ú–æ–¥–µ–ª—å | –†–∞–∑–º–µ—Ä | –í—Ä–µ–º—è (20 –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤) | –ö–∞—á–µ—Å—Ç–≤–æ | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
|--------|--------|----------------------|----------|--------------|
| qwen2.5:3b | ~2GB | ~20-30s | –•–æ—Ä–æ—à–µ–µ | ‚≠ê –ë—ã—Å—Ç—Ä—ã–π |
| qwen2.5 | ~4GB | ~30-45s | –û—Ç–ª–∏—á–Ω–æ–µ | ‚≠ê‚≠ê –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è |
| qwen2.5:7b | ~4GB | ~40-60s | –û—Ç–ª–∏—á–Ω–æ–µ | ‚≠ê‚≠ê –ö–∞—á–µ—Å—Ç–≤–æ |
| llama3.2:3b | ~2GB | ~20-30s | –•–æ—Ä–æ—à–µ–µ | ‚≠ê –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ |
| mistral | ~4GB | ~30-45s | –û—Ç–ª–∏—á–Ω–æ–µ | ‚≠ê‚≠ê –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ |

## –ö–æ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### OllamaGenerateRequest (—É–ø—Ä–æ—â–µ–Ω)
```kotlin
@Serializable
data class OllamaGenerateRequest(
    val model: String,
    val prompt: String,
    val stream: Boolean = false
)
```

### OllamaGenerateResponse (–ø–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ API)
```kotlin
@Serializable
data class OllamaGenerateResponse(
    val model: String,
    val created_at: String,
    val response: String,
    val done: Boolean,
    val done_reason: String? = null,
    val context: List<Int>? = null,
    // ... timing fields
)
```

### –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç
–ü—Ä–æ–º–ø—Ç —Ç–µ–ø–µ—Ä—å —è–≤–Ω–æ –ø—Ä–æ—Å–∏—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Ç–æ–ª—å–∫–æ JSON –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π, —á—Ç–æ —É–ª—É—á—à–∞–µ—Ç –ø–∞—Ä—Å–∏–Ω–≥.

---

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!

**–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã**:
- `src/main/kotlin/core/rag/LlmReranker.kt` - –ø–µ—Ä–µ–ø–∏—Å–∞–Ω OllamaReranker
- `RAG_RERANKING_QUICK_REFERENCE.md` - –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

